<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>DHT22 Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #ece9e6, #ffffff);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .dashboard {
      width: 90%;
      max-width: 680px;
      background: #fff;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }
    h2 {
      margin: 0;
      color: #333;
    }
    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      user-select: none;
    }
    .toggle input {
      width: 44px;
      height: 24px;
      appearance: none;
      background: #ccc;
      border-radius: 999px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .toggle input::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle input:checked {
      background: #0072ff;
    }
    .toggle input:checked::after {
      transform: translateX(20px);
    }

    .label {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .bar {
      width: 100%;
      background: #f0f0f0;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 25px;
      height: 35px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
    }
    .fill {
      height: 100%;
      text-align: center;
      color: #fff;
      line-height: 35px;
      font-weight: bold;
      font-size: 16px;
      transition: width 0.5s ease;
    }
    .temp {
      background: linear-gradient(90deg, #ff6a00, #ee0979);
    }
    .hum {
      background: linear-gradient(90deg, #00c6ff, #0072ff);
    }
    .avg {
      text-align: left;
      font-size: 16px;
      margin-top: 6px;
      color: #444;
      font-weight: 600;
    }
    .avg-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 10px;
    }
    .alert {
      text-align: center;
      font-size: 18px;
      margin-top: 12px;
      font-weight: bold;
      color: #fff;
      padding: 10px;
      border-radius: 10px;
      display: none;
      background: linear-gradient(90deg, #ff0000, #cc0000);
      box-shadow: 0 0 15px rgba(255,0,0,0.6);
    }

    /* LCD section */
    .lcd-card {
      margin-top: 28px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .lcd-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .lcd-help {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }
    .lcd-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .lcd-textarea {
      width: 100%;
      resize: vertical;
      min-height: 120px; /* ~ 4 d√≤ng */
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      outline: none;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.03);
    }
    .lcd-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .btn {
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary {
      background: #0072ff;
      color: #fff;
    }
    .btn-outline {
      background: #fff;
      color: #0072ff;
      border: 1px solid #0072ff;
    }
    .lcd-counter {
      margin-left: auto;
      font-size: 12px;
      color: #555;
    }
    .lcd-preview {
      margin-top: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #fafafa;
      border: 1px dashed #ddd;
      border-radius: 8px;
      padding: 8px 10px;
      white-space: pre;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="top-row">
      <h2>üå°Ô∏è DHT22 Monitor üíß</h2>
      <label class="toggle" title="B·∫≠t/t·∫Øt c√°c c·∫£nh b√°o">
        <span>C·∫£nh b√°o</span>
        <input id="toggleAlerts" type="checkbox" checked>
      </label>
    </div>

    <div class="label">Nhi·ªát ƒë·ªô</div>
    <div class="bar">
      <div id="tempBar" class="fill temp" style="width:0%">0 ¬∞C</div>
    </div>

    <div class="label">ƒê·ªô ·∫©m</div>
    <div class="bar">
      <div id="humBar" class="fill hum" style="width:0%">0 %</div>
    </div>

    <!-- Hi·ªÉn th·ªã trung b√¨nh -->
    <div class="avg-wrap">
      <div id="avgTemp" class="avg">Trung b√¨nh nhi·ªát ƒë·ªô 3 l·∫ßn ƒëo g·∫ßn nh·∫•t: -- ¬∞C</div>
      <div id="avgHum" class="avg">Trung b√¨nh ƒë·ªô ·∫©m 3 l·∫ßn ƒëo g·∫ßn nh·∫•t: -- %</div>
    </div>

    <!-- C·∫£nh b√°o -->
    <div id="tempAlert" class="alert">‚ö†Ô∏è C·∫£nh b√°o: Nhi·ªát ƒë·ªô qu√° cao! (> 50 ¬∞C) ‚ö†Ô∏è</div>
    <div id="humAlert" class="alert">‚ö†Ô∏è C·∫£nh b√°o: ƒê·ªô ·∫©m qu√° cao! (‚â• 85%) ‚ö†Ô∏è</div>

    <!-- LCD 20x4 input/publish -->
    <div class="lcd-card">
      <div class="lcd-title">üñ•Ô∏è LCD 20x4</div>
      <div class="lcd-help">
        Nh·∫≠p t·ªëi ƒëa 4 d√≤ng. Tr√™n LCD, n·∫øu d√≤ng > 20 k√Ω t·ª± s·∫Ω t·ª± cu·ªôn t·ª´ ph·∫£i sang tr√°i v√† quay l·∫°i ƒë·∫ßu.
      </div>
      <div class="lcd-grid">
        <textarea id="lcdText" class="lcd-textarea" rows="4" cols="20" placeholder="Nh·∫≠p n·ªôi dung (t·ªëi ƒëa 4 d√≤ng)"></textarea>
      </div>
      <div class="lcd-actions">
        <button id="btnPreview" class="btn btn-outline">Xem tr∆∞·ªõc 20x4</button>
        <button id="btnSend" class="btn btn-primary">G·ª≠i l√™n LCD</button>
        <div id="charCount" class="lcd-counter">0 k√Ω t·ª±</div>
      </div>
      <div id="lcdPreview" class="lcd-preview" style="display:none;"></div>
    </div>
  </div>

  <script>
    const client = new Paho.MQTT.Client("broker.emqx.io", 8083, "web-" + Math.random());
    const LCD_TOPIC = "tuanprohl/lcd_text"; // ƒë·ªïi n·∫øu c·∫ßn ƒë·ªìng b·ªô v·ªõi ESP32

    // Tr·∫°ng th√°i hi·ªán t·∫°i
    let alertsEnabled = true;
    let lastTemp = null;
    let lastHum = null;

    function applyAlerts() {
      const tempA = document.getElementById("tempAlert");
      const humA  = document.getElementById("humAlert");

      if (!alertsEnabled) {
        tempA.style.display = "none";
        humA.style.display = "none";
        return;
      }
      if (lastTemp !== null && lastTemp > 50) {
        tempA.style.display = "block";
      } else {
        tempA.style.display = "none";
      }
      if (lastHum !== null && lastHum >= 85) {
        humA.style.display = "block";
      } else {
        humA.style.display = "none";
      }
    }

    client.onMessageArrived = function (msg) {
      if (msg.destinationName === "tuanprohl/temp") {
        const t = parseFloat(msg.payloadString);
        lastTemp = isNaN(t) ? null : t;
        document.getElementById("tempBar").style.width = msg.payloadString + "%";
        document.getElementById("tempBar").innerText = msg.payloadString + " ¬∞C";
        applyAlerts();
      } else if (msg.destinationName === "tuanprohl/hum") {
        const h = parseFloat(msg.payloadString);
        lastHum = isNaN(h) ? null : h;
        document.getElementById("humBar").style.width = msg.payloadString + "%";
        document.getElementById("humBar").innerText = msg.payloadString + " %";
        applyAlerts();
      } else if (msg.destinationName === "tuanprohl/temp_avg") {
        document.getElementById("avgTemp").innerText =
          "Trung b√¨nh nhi·ªát ƒë·ªô 3 l·∫ßn ƒëo g·∫ßn nh·∫•t: " + msg.payloadString + " ¬∞C";
      } else if (msg.destinationName === "tuanprohl/hum_avg") {
        document.getElementById("avgHum").innerText =
          "Trung b√¨nh ƒë·ªô ·∫©m 3 l·∫ßn ƒëo g·∫ßn nh·∫•t: " + msg.payloadString + " %";
      }
    };

    client.connect({
      onSuccess: () => {
        console.log("‚úÖ Connected to MQTT broker");
        client.subscribe("tuanprohl/temp");
        client.subscribe("tuanprohl/hum");
        client.subscribe("tuanprohl/temp_avg");
        client.subscribe("tuanprohl/hum_avg");
      },
      onFailure: (err) => {
        console.error("‚ùå MQTT connection failed", err);
      }
    });

    // Toggle c·∫£nh b√°o
    document.getElementById("toggleAlerts").addEventListener("change", (e) => {
      alertsEnabled = e.target.checked;
      applyAlerts();
    });

    // ------- LCD helpers -------
    const $ta = document.getElementById("lcdText");
    const $count = document.getElementById("charCount");
    const $preview = document.getElementById("lcdPreview");
    const $btnPreview = document.getElementById("btnPreview");
    const $btnSend = document.getElementById("btnSend");

    function removeDiacritics(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/ƒë/g, "d")
        .replace(/ƒê/g, "D")
        .replace(/[^\x20-\x7E\n]/g, "");
    }

    function getLines(raw) {
      const sanitized = removeDiacritics(raw);
      const lines = sanitized.split(/\r?\n/).slice(0, 4);
      while (lines.length < 4) lines.push("");
      return lines; // KH√îNG c·∫Øt/pad 20 k√Ω t·ª±, ƒë·ªÉ firmware cu·ªôn
    }

    function getWindow20(line) {
      // L·∫•y khung nh√¨n 20 k√Ω t·ª± ƒë·∫ßu (nh∆∞ LCD khi m·ªõi hi·ªán)
      if (line.length <= 20) return line.padEnd(20, " ");
      return line.substring(0, 20);
    }

    function updateCounter() {
      $count.textContent = `${$ta.value.length} k√Ω t·ª±`;
    }

    function showPreview() {
      const lines = getLines($ta.value);
      const firstWindow = lines.map(getWindow20).join("\n");
      $preview.style.display = "block";
      $preview.textContent = firstWindow + "\n\n(L∆∞u √Ω: D√≤ng > 20 k√Ω t·ª± s·∫Ω t·ª± cu·ªôn tr√™n LCD)";
    }

    function publishLcd() {
      if (!client.isConnected()) {
        alert("MQTT ch∆∞a k·∫øt n·ªëi, vui l√≤ng ch·ªù...");
        return;
      }
      const lines = getLines($ta.value);
      const payload = lines.join("\n"); // 4 d√≤ng, c√≥ th·ªÉ d√†i > 20
      const message = new Paho.MQTT.Message(payload);
      message.destinationName = LCD_TOPIC;
      message.qos = 0;
      client.send(message);
      console.log("üì§ Sent to", LCD_TOPIC, JSON.stringify(lines));
      alert("ƒê√£ g·ª≠i n·ªôi dung LCD!");
    }

    $ta.addEventListener("input", updateCounter);
    $btnPreview.addEventListener("click", showPreview);
    $btnSend.addEventListener("click", publishLcd);
    updateCounter();
  </script>
</body>
</html>